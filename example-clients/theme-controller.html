<!DOCTYPE html>
<html>
	<head>
		<title>MediaHubClient as theme controller</title>
		<style>
			#step2, #step3 {
				opacity: 0;
				transition: opacity 0.5s;
			}

			#status {
				color: red;
			}

			label {
				display: block;
			}

			button {
				margin: 0 5px;
			}
		</style>
	</head>
	<body>
		<h1>MediaHubClient as theme controller</h1>
		
		<h2>Step 1: Login to a hub</h2>
		
		<form id='login-form'>
			<h3 id='status'></h3>
			<label>Hub Url: <input type='url' name='url' required /></label>
			<label>Hub Password: <input type='password' name='password' required /></label>
			<input type='submit' id='submit' name='submit' />
		</form>

		<div id='step2'>
			<h2>Step 2: Select a Scene</h2>
			<label>
				Select a Scene:
				<select name='sceneSelect' id='scene-select'></select>
			</label>	
		</div>

		<div id='step3'>
			<h2>Step 3: Select theme(s) to trigger</h2>
			<select name='themeSelect' id='theme-select' multiple></select>
		</div>
		

		<!-- load socket.io library from active hub instance so that the client/server library
			 versions will match -->
		<script src='http://smamediahub.azurewebsites.net/socket.io/socket.io.js'></script>

		<script>
			(function() {
				'use strict';

				var socket,
					currentSceneId,
					errorBox = document.querySelector('#status'),
					step2 = document.querySelector('#step2'),
					step3 = document.querySelector('#step3'),
					sceneSelect = document.querySelector('#scene-select'),
					themeSelect = document.querySelector('#theme-select'),
					submitBtn = document.querySelector('#submit');

				/* SETUP EVENT LISTENERS */
				document.querySelector('#login-form').addEventListener('submit', function(e) {
					e.preventDefault();
					
					errorBox.innerHTML = '';
					submitBtn.disabled = true;
					submitBtn.value = 'Logging in...';
					
					tryLogin(this.url.value, this.password.value);
					
				});

				
				sceneSelect.addEventListener('change', function(e) {
					showThemes(this.value);
				});


				themeSelect.addEventListener('change', function(e) {
						var theme = e.target.innerHTML;
						var selectedThemes = [];
						for (var i = 0; i < this.length; i++) {
							if (this[i].selected === true) {
								selectedThemes.push(this[i].value);
							}
						}

						socket.emit('sendCommand', currentSceneId, 'showThemes', selectedThemes);
				});

				function tryLogin (url, password) {
					// connect  
					socket = io(url, {
				        forceNew: true
				    });

				    socket.on('connect', function() {
				    	socket.emit('auth', {password: password}, function(err) {
				    		if (err) {
				    			showError(err);
				    		} else {
				    			showSceneNames();
				    		}

				    		submitBtn.disabled = false;
				    		submitBtn.value = 'Submit';
				    	});
				    });
				}

				// update dropdown list to scene names
				function showSceneNames () {
					// clear old options
					sceneSelect.innerHTML = '';

					socket.emit('listScenes', function(err, names) {
						// build new options with list of scenes in hub
						sceneSelect.appendChild(document.createElement('option'));
						for (var i = 0; i < names.length; i++) {
							var opt = document.createElement('option');
							opt.value = names[i]._id;
							opt.innerHTML = names[i].name;
							sceneSelect.appendChild(opt);
						}

						step2.style.opacity = 1;
					});						
				}

				function showThemes (sceneId) {
					// hide and clear out old buttons if any
					step3.style.opacity = 0;
					themeSelect.innerHTML = '';
					currentSceneId = sceneId;
					// get the scene json
					socket.emit('loadScene', sceneId, function(err, scene) {
						// make an option for each scene name
						if (scene.themes && Object.keys(scene.themes).length > 0) {
							for (var theme in scene.themes) {
								var opt = document.createElement('option');
								opt.value = theme;
								opt.innerHTML = theme;
								themeSelect.appendChild(opt);
							}	
						}
						
						// show the buttons
						step3.style.opacity = 1;
					});
				}

				function showError (msg) {
					errorBox.innerHTML = msg.toString();
				}
				
			}).call(this);
			
		</script>
	</body>
</html>